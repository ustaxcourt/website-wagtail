{% load static wagtailcore_tags wagtailuserbar env_tags %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>
      {% block title %}
        {% if page.seo_title %}
          {{ page.seo_title }}
        {% else %}
          {{ page.title }}
        {% endif %}
      {% endblock %}
      {% block title_suffix %}
        {% wagtail_site as current_site %}
        {% if current_site and not page.is_site_root %}
          | United States Tax Court
        {% endif %}
      {% endblock %}
    </title>
    {% if page.search_description %}
      <meta name="description" content="{{ page.search_description }}" />
    {% endif %}
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    {# Force all links in the live preview panel to be opened in a new tab #}
    {% if request.in_preview_panel %}
      <base target="_blank" />
    {% endif %}

    {# Favicon #}

    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}" />

    <link rel="apple-touch-icon" sizes="57x57" href="{% static 'images/icons/apple-icon-57x57.png' %}">
    <link rel="apple-touch-icon" sizes="60x60" href="{% static 'images/icons/apple-icon-60x60.png' %}">
    <link rel="apple-touch-icon" sizes="72x72" href="{% static 'images/icons/apple-icon-72x72.png' %}">
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'images/icons/apple-icon-76x76.png' %}">
    <link rel="apple-touch-icon" sizes="114x114" href="{% static 'images/icons/apple-icon-114x114.png' %}">
    <link rel="apple-touch-icon" sizes="120x120" href="{% static 'images/icons/apple-icon-120x120.png' %}">
    <link rel="apple-touch-icon" sizes="144x144" href="{% static 'images/icons/apple-icon-144x144.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icons/apple-icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/icons/apple-icon-180x180.png' %}">
    <link rel="icon" type="image/png" sizes="192x192"  href="{% static 'images/icons/android-icon-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/icons/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'images/icons/favicon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/icons/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'images/icons/manifest.json' %}">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="{% static 'images/icons/ms-icon-144x144.png' %}">
    <meta name="theme-color" content="#ffffff">

    {# Global stylesheets #}
    <link rel="stylesheet" type="text/css" href="{% static 'uswds/css/styles.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/app.css' %}" />

    {# Icons #}
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.29.0/dist/tabler-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />
    <link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">

    {# Web Fonts #}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css?family=Noto Serif JP:400,700," rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Source Sans Pro:400,700," rel="stylesheet" />

    {% block extra_css %}
      {# Override this in templates to add extra stylesheets #}
    {% endblock %}
  </head>

  <body class="{% block body_class %}

    {% endblock %}">
    {% include 'banner.html' %}
    {% get_enviroment as environment%}
    {% if environment != "production" %}
      {% include 'alert_banner.html' %}
    {% endif %}
    {% include 'header.html' %}

    {% wagtailuserbar %}

    {% block content %}

    {% endblock %}

    {% include 'footer.html' %}

    <button title="Scroll to top" id="scroll-to-top" type="button" class="usa-button width-auto fade-in">
      <img src="{% static 'uswds/img/usa-icons/arrow_drop_up.svg' %}" role="img" alt="scroll to top button" aria-hidden="true" />
    </button>

    {# Global javascript #}
    <script type="text/javascript" src="{% static 'js/app.js' %}"></script>
    <script type="text/javascript" src="{% static 'uswds/js/uswds.min.js' %}"></script>

    {% include 'google_analytics.html' %}

    {% block extra_js %}
      {# Override this in templates to add extra javascript #}
    {% endblock %}
  </body>
</html>


<script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll("a").forEach(link => {
        link.addEventListener("click", function (event) {
          let href = this.getAttribute("href")

          if (!href) {
            return;
          }

          if (isSamedomain(href) && isPdf(href)) {
            window.open(href, "_blank");
            event.preventDefault();
            return;
          }

          if (href.startsWith("mailto:") || href.startsWith("tel:") || isSamedomain(href)) {
            return;
          }

          event.preventDefault();

          if (isSubdomain(href)) {
            window.open(href, "_blank");
          } else {
            let newTab = window.open("/redirect/", "_blank");
            if (newTab) {
              newTab.sessionStorage.setItem("redirect_url", href);
            } else{
              alert("Pop-up blocked!  Please allow pop-ups for this site.");
            }
          }

        });
      });
    });

    function getRootDomain(url){
        try{
          let hostname = new URL(url, window.location.origin).hostname;
          let parts = hostname.split(".").reverse();

          if(parts.length >= 2) {
            return parts[1] + "." + parts[0]
          }
          return hostname
        } catch (e) {
          return null
        }
      }

      function isSamedomain(url){
        let currentDomain = window.location.hostname;
        let s3StaticDomainPattern = /.*ustc-website-assets\.s3\.amazonaws\.com$/;
        let linkDomain;

        try{
          linkDomain = new URL(url, window.location.origin).hostname;
        }catch (e) {
          return true;
        }

        return (linkDomain === currentDomain || s3StaticDomainPattern.test(linkDomain));
      }

      function isSubdomain(url) {
        let currentRootDomain = getRootDomain(window.location.hostname);
        let linkRootDomain = getRootDomain(url);

        return linkRootDomain && linkRootDomain === currentRootDomain;
      }

      function isPdf(url) {
        return url.endsWith('.pdf')
      }
</script>
