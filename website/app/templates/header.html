{% load static wagtailcore_tags %}
{% load wagtailcore_tags navigation_tags %}
<style>
    header#top-navigation .blue-banner {
        background-color: var(--dark-blue);
        height: 116px;
    }

    header#top-navigation .blue-banner .dawson {
        width: 60px;
    }

    header#top-navigation .logo-seal {
        width: 70px;
    }

    header#top-navigation .search-form {
        display: flex;
        gap: 8px;
        margin: 0 20px;
    }

    header#top-navigation .search-form input {
        padding: 8px 12px;
        border: 1px solid var(--light-blue);
        border-radius: 4px;
        min-width: 200px;
    }

    header#top-navigation .search-form button {
        background-color: var(--light-blue);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    header#top-navigation .search-form button:hover {
        background-color: var(--dark-blue);
    }

    header#top-navigation .navigation {
        border: solid var(--light-blue);
        background-color: #f2f4f4;
        border-width: 5px 0px 1px 0px;
        padding: 0px 0px;
        margin: 0;
        display: flex;
        justify-content: center;
        min-height: 52px;
    }

    header#top-navigation .navigation i {
        font-size: 0.7rem;
    }

    header#top-navigation .navigation-header {
        white-space: nowrap;
    }

    header#top-navigation .navigation-header:hover {
        background-color: var(--light-gray-hover);
    }

    header#top-navigation .navigation-header .link,
    header#top-navigation .navigation-header a {
        display: flex;
        align-items: center;
        gap: 4px;
        text-decoration: none;
    }

    header#top-navigation .navigation-header .link:hover,
    header#top-navigation .navigation-header a:hover {
        text-decoration: none;
        color: var(--link-blue);
    }

    header#top-navigation .navigation-header .link {
        background: none;
        border: none;
        padding: 0 30px;
        font: inherit;
        color: var(--light-blue);
        cursor: pointer;
        width: 100%;
        height: 100%;
        justify-content: flex-start;
        font-weight: bold;
        font-size: 1rem;
    }

    header#top-navigation .navigation-header .link > div {
        display: flex;
        align-items: center;
        gap: 4px;
        width: 100%;
    }

    header#top-navigation .navigation-list {
        display: none;
        list-style-type: none;
        background-color: var(--light-blue);
    }

    header#top-navigation .navigation-list .nav-link {
        color: #FFFFFF;
        font-weight: bold;
    }

    header#top-navigation .navigation-list .nav-link:hover {
        background: white;
        border-radius: 6px;
    }

    header#top-navigation .navigation-list .nav-link a {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #FFFFFF;
    }

    header#top-navigation .navigation-list .nav-link a:hover {
        color: var(--light-blue);
    }

    @media (min-width: 854px) {
        header#top-navigation .nav-hamburger {
            height: 16px;
            display: none;
        }

        header#top-navigation .navigation-header {
            height: 55px;
            display: flex;
            align-items: center;
            position: relative;
            padding: 0;
        }

        header#top-navigation .navigation-header:hover .navigation-list,
        header#top-navigation .navigation-header.active .navigation-list {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        header#top-navigation .navigation-header:hover {
            z-index: 501;
        }

        header#top-navigation .navigation-header .navigation-list {
            position: absolute;
            min-width: 320px;
            top: 55px;
            left: 0;
            z-index: 500;
            flex-direction: column;
            padding: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        header#top-navigation .navigation-header .navigation-list .nav-link a {
            padding: 3px 10px;
        }

        header#top-navigation .navigation-header .link:focus {
            outline: 2px solid var(--link-blue);
            outline-offset: -2px;
        }
    }

    @media (min-width: 854px) and (max-width: 960px) {
        header#top-navigation .navigation .navigation-header .link {
            padding: 0 15px;
            font-size: 0.9rem;
        }

        header#top-navigation .navigation .navigation-header .link > div {
            gap: 2px;
        }
    }

    @media (min-width: 961px) {
        header#top-navigation .navigation-header .link {
            padding: 0 30px;
            font-size: 1rem;
        }

        header#top-navigation .navigation-header .link > div {
            gap: 4px;
        }
    }

    @media (max-width: 639px) {
        header#top-navigation .blue-banner {
            height: auto;
            padding: 10px 0;
        }

        header#top-navigation .usa-header__inner {
            flex-direction: column;
            gap: 10px;
        }

        header#top-navigation .search-form {
            margin: 10px 0;
            width: 100%;
            order: 2;
        }

        header#top-navigation .search-form input {
            flex: 1;
        }

        header#top-navigation .dawson-link {
            order: 3;
        }
    }

    @media (max-width: 853px) {
        header#top-navigation .navigation-bar {
            border: solid var(--light-blue);
            background-color: #f2f4f4;
            border-width: 5px 0px 1px 0px;
            display: flex;
            flex-direction: column;
            align-items: normal;
            justify-content: center;
        }

        header#top-navigation .navigation-bar .nav-hamburger {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 24px;
            margin: 10px;
            background: none;
            border: none;
            cursor: pointer;
        }

        header#top-navigation .navigation-bar .navigation {
            flex-direction: column;
            gap: 0px;
            border-width: 0;
            min-height: 0;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header {
            display: none;
            background-color: #efefef;
            padding: 0;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .navigation-list {
            display: none;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .link {
            white-space: normal;
            height: auto;
            min-height: 44px;
            padding: 8px 20px;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .link > div {
            flex-wrap: wrap;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .nav-link a {
            white-space: normal;
            padding: 8px 10px;
            min-height: 44px;
            height: auto;
            display: flex;
            align-items: start;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .nav-link a i {
            position: relative;
            top: 14px;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header:hover {
            background-color: var(--light-blue);
        }

        header#top-navigation .navigation-bar .navigation .navigation-header:hover a,
        header#top-navigation .navigation-bar .navigation .navigation-header:hover .link {
            color: white;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .link:hover {
            color: white;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header.displayed-navigation-header {
            display: flex;
            flex-direction: column;
            width: 100%;
            line-height: 44px;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header.displayed-navigation-header .navigation-list {
            display: none;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header.displayed-navigation-header .navigation-list.displayed-navigation-list {
            display: flex;
            flex-direction: column;
            padding-left: 10px;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .nav-link:hover {
            background: white;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .nav-link:hover a {
            color: var(--light-blue) !important;
        }

        header#top-navigation .navigation-bar .navigation .navigation-header .nav-link:hover a i {
            color: var(--light-blue);
        }
    }
</style>
<header id="top-navigation">
    <div class="blue-banner">
        <div class="grid-container padding-1">
            <div class="usa-header__inner display-flex flex-justify flex-align-center">
                <a href="/">
                    <img class="tablet:display-none logo-seal"
                         src="{% static 'images/header/logo_seal.webp' %}"
                         alt="US Tax Court Logo" />
                    <img class="display-none tablet:display-block"
                         src="{% static 'images/header/logo.webp' %}"
                         alt="US Tax Court Logo" />
                </a>
                <form class="search-form" action="/search/" method="get">
                    <input type="text"
                           name="query"
                           placeholder="Search..."
                           aria-label="Search"
                           data-testid="search-input">
                    <button type="submit" data-testid="search-button">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        Search
                    </button>
                </form>
                <a href="https://dawson.ustaxcourt.gov/" class="dawson-link">
                    <img class="dawson"
                         src="{% static 'images/header/dawson.webp' %}"
                         alt="Dawson Logo" />
                </a>
            </div>
        </div>
    </div>
    <div class="navigation-bar" data-testid="navigation-bar">
        <button class="nav-hamburger"
                aria-label="Toggle mobile menu"
                onclick="toggleHeaders()">
            <i class="fa-solid fa-bars"></i>
        </button>
        <ul class="navigation">
            {% get_navigation_menu as nav %}
            {% for section in nav.menu_items %}
                <li class="navigation-header">
                    {% if section.value.external_url %}
                        <a href="{{ section.value.external_url }}"
                           target="_blank"
                           class="link"
                           data-testid="nav-button-{{ section.value.title|slugify }}">
                            <div>{{ section.value.title }}</div>
                        </a>
                    {% else %}
                        <button aria-expanded="false"
                                class="link"
                                data-testid="nav-button-{{ section.value.title|slugify }}"
                                onclick="toggleMenuItems(this)">
                            <div>
                                {{ section.value.title }}
                                <i class="fa-solid fa-chevron-right"></i>
                            </div>
                        </button>
                    {% endif %}
                    <ul class="navigation-list"
                        data-testid="nav-list-{{ section.value.title|slugify }}">
                        {% for sub_link in section.value.sub_links %}
                            <li class="nav-link">
                                {% if sub_link.external_url %}
                                    <a target="_blank"
                                       href="{{ sub_link.external_url }}"
                                       data-testid="nav-link-{{ sub_link.title|slugify }}">
                                        <i class="fa-solid fa-chevron-right"></i>
                                        {{ sub_link.title }}
                                    </a>
                                {% elif sub_link.page %}
                                    <a href="{% pageurl sub_link.page %}"
                                       data-testid="nav-link-{{ sub_link.title|slugify }}">
                                        <i class="fa-solid fa-chevron-right"></i>
                                        {{ sub_link.title }}
                                    </a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>
</header>
<script>
    function toggleHeaders() {
        const navigationHeaders = document.querySelectorAll('.navigation-header');
        navigationHeaders.forEach(header => {
            header.classList.toggle('displayed-navigation-header');
        });
    }

    function toggleMenuItems(button) {
        const navigationList = button.nextElementSibling;
        navigationList.classList.toggle('displayed-navigation-list');

        // Update aria-expanded attribute
        const isExpanded = navigationList.classList.contains('displayed-navigation-list');
        button.setAttribute('aria-expanded', isExpanded);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const navigationHeaders = document.querySelectorAll('.navigation-header');

        navigationHeaders.forEach(header => {
            // Handle clicks
            header.addEventListener('click', function(e) {
                navigationHeaders.forEach(h => {
                    if (h !== header) h.classList.remove('active');
                });
                header.classList.toggle('active');
            });

            // Handle hover
            header.addEventListener('mouseenter', function() {
                const hasSubLinks = header.querySelector('.navigation-list li');
                if (hasSubLinks) {
                    navigationHeaders.forEach(h => {
                        if (h !== header) h.classList.remove('active');
                    });
                    header.classList.add('active');
                }
            });

            header.addEventListener('mouseleave', function() {
                header.classList.remove('active');
            });

            // Add keyboard navigation for dropdown items
            header.addEventListener('keydown', function(e) {
                const activeList = header.querySelector('.navigation-list');
                const links = activeList?.querySelectorAll('.nav-link a');
                if (!links?.length) return;

                const currentFocus = document.activeElement;
                let currentIndex = Array.from(links).indexOf(currentFocus);

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentIndex === -1) {
                            links[0].focus();
                        } else {
                            const nextIndex = (currentIndex + 1) % links.length;
                            links[nextIndex].focus();
                        }
                        break;

                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentIndex === -1) {
                            links[links.length - 1].focus();
                        } else {
                            const prevIndex = (currentIndex - 1 + links.length) % links.length;
                            links[prevIndex].focus();
                        }
                        break;
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.navigation-header')) {
                navigationHeaders.forEach(header => {
                    header.classList.remove('active');
                });
            }
        });

        // Close dropdown when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close desktop dropdowns
                navigationHeaders.forEach(header => {
                    header.classList.remove('active');
                    // Close mobile menu
                    header.classList.remove('displayed-navigation-header');
                    const navigationList = header.querySelector('.navigation-list');
                    if (navigationList) {
                        navigationList.classList.remove('displayed-navigation-list');
                    }
                });
            }
        });
    });
</script>
