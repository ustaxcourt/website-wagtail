{% extends "wagtailadmin/admin_base.html" %}
{% load i18n wagtailadmin_tags %} {# For {% icon %} and other Wagtail tags #}

{% block titletag %}
    {{ title|default:"Switch User Role for Testing" }}
{% endblock %}

{% block bodyclass %}
    role-switcher-page section-role-switcher {# Example body classes #}
{% endblock %}

{# You can add page-specific CSS here if needed later #}
{% block extra_css %}
    {{ block.super }}
    <style>
        .role-switcher-page .fieldWrapper {
            margin-bottom: 1.5em;
            padding: 0.5em;
            border: 1px solid #e0e0e0; /* Light border for field wrapper */
            border-radius: 4px;
        }
        .role-switcher-page .fieldWrapper label {
            font-weight: bold;
            display: block;
            margin-bottom: 0.3em;
        }
        .role-switcher-page .help {
            font-size: 0.9em;
            color: #666;
            margin-top: 0.2em;
        }
        .role-switcher-page .error-message {
            color: #d9534f; /* Error color */
            font-size: 0.9em;
            margin-top: 0.2em;
        }
        .role-switcher-page hr {
            margin-top: 1.5em;
            margin-bottom: 1.5em;
        }
    </style>
{% endblock extra_css %}

{% block furniture %}
<main id="main" class="content-wrapper"> {# Standard Wagtail main content wrapper #}
    {% include "wagtailadmin/shared/header.html" with title=title|default:"Switch User Role for Testing" icon="user" classname="merged" %}

    <div class="nice-padding"> {# Standard Wagtail padding class #}
        <h2 style="color: green; border: 1px dashed green; padding: 10px;">Render Test Point 1: Inside nice-padding</h2>
        <p>If you see this message and the green bordered title, the basic page structure is loading into the 'furniture' block.</p>
        <hr>

        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
            <hr>
        {% endif %}

        {% if is_assuming_role %}
            <div class="w-alert w-alert--warning" role="alert">
                <p>You are currently assuming the role: <strong>{{ assumed_role_name }}</strong>. Your superuser privileges are temporarily inactive.</p>
            </div>
            <form method="post" action="{% url 'switch_role' %}" class="w-mt-4">
                {% csrf_token %}
                {# revert_role_form is simple, likely just needs the button #}
                {% for field in revert_role_form %}{{ field }}{% endfor %} {# Hidden fields if any #}
                <button type="submit" name="revert_role" class="button">Revert to Original Permissions</button>
            </form>
            <hr class="w-my-4">
            <p>To assume a different role, please revert to your original permissions first.</p>
        {% else %}
            <p>Select a role below to temporarily assume its permissions for testing purposes. Your superuser status will be temporarily disabled while assuming a role.</p>

            <form method="post" action="{% url 'switch_role' %}" novalidate class="w-mt-4">
                {% csrf_token %}

                {# --- Basic Django Form Rendering (Bypassing field_as_li.html) --- #}
                {% for field in role_switch_form %}
                    <div class="fieldWrapper"> {# Simple wrapper for styling #}
                        {{ field.label_tag }}
                        {{ field }} {# This renders the widget, e.g., <select> #}
                        {% if field.help_text %}
                            <p class="help">{{ field.help_text }}</p>
                        {% endif %}
                        {% if field.errors %}
                            <p class="error-message">
                                {% for error in field.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </p>
                        {% endif %}
                    </div>
                {% endfor %}
                {# --- End Basic Django Form Rendering --- #}

                <div class="form-actions w-pt-4"> {# Wagtail class for padding-top #}
                    <button type="submit" name="assume_role" class="button button-longrunning" data-controller="w-progress" data-action="w-progress#activate" data-w-progress-active-value="{% trans 'Switchingâ€¦' %}">
                        {% icon name="spinner" classname="w-mr-2" %}
                        <em data-w-progress-target="label">{% trans "Assume Selected Role" %}</em>
                    </button>
                </div>
            </form>
        {% endif %}
    </div>
</main>
{% endblock furniture %}